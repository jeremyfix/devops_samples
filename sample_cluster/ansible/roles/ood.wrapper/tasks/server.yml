---
- name: install dependencies
  package:
    name: "{{ ood_master_sw_deps }}"
    state: present
  when: ood_master_sw_deps is defined

- name: install Open OnDemand
  include_role:
    name: ood-ansible

- name: create clusters dir
  file:
    path: "{{ ood_cluster_config_dir }}"
    mode: "0755"
    state: directory
  tags:
    - configure

- name: configure slurm cluster connector
  template:
    src: cluster.yml.j2
    mode: "0644"
    dest: "{{ ood_cluster_config_dir }}/{{ ood_cluster_name }}.yml"
  tags:
    - configure

- name: configure front page
  blockinfile:
    path: "{{ ood_config_dir }}/nginx_stage.yml"
    block : |
      {{ ood_frontpage_config }}
  tags:
    - configure

- name: install package dependency for htpasswd module
  package:
    name: "{{ item }}"
    state: present
  with_items:
    - python-passlib
    - python3-passlib
  tags:
    - configure

- name: create .htpasswd entries
  htpasswd:
    path: "{{ ood_htpasswd_file }}"
    name: "{{ user }}"
    password: "{{ ood_default_password }}"
    mode: "0600"
    create: yes
  tags:
    - configure

- name: install required apache module
  apache2_module:
    state: present
    name: proxy_wstunnel
  register: mod_install
  tags:
    - configure

- name: restart apache after module install
  systemd:
    service: "{{ ood_apache_service_name }}"
    state: restarted
  when: mod_install.changed  # noqa no-handler
  tags:
    - configure

- name: create ssh key pair for default user
  openssh_keypair:
    path: "/home/{{ user }}/.ssh/id_rsa"
    owner: "{{ user }}"
  tags:
    - configure

- name: get ssh pub key
  slurp:
    src: "/home/{{ user }}/.ssh/id_rsa.pub"
  register: user_pub_key
  tags:
    - configure

- name: set ssh authorized key
  authorized_key:
    user: "{{ user }}"
    state: present
    key: "{{ user_pub_key['content'] | b64decode }}"
  tags:
    - configure
